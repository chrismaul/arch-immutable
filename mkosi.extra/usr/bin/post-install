#!/bin/bash -ex
if [ "$(ls $PACKAGE_DIR/* | wc -l)" -gt "0" ]
then
  pacman -U $PACKAGE_DIR/* --noconfirm --needed
fi

for i in \
  etc/environment \
  etc/xdg/ \
  etc/cloud/ \
  etc/security/ \
  etc/ca-certificates/ \
  etc/ssl/ \
  etc/pam.d/ \
  etc/profile.d/ \
  etc/bash.bashrc \
  etc/bash.bash_logout \
  $SYNC_FILES
do
  if [ -e "/$i" ]
  then
    rsync -av /$i /usr/share/factory/$i
  fi
done

if [ -d "$PROFILE_FILES" ]
then
  rsync -av $PROFILE_FILES/ /
fi

sed -i "s/^HOOKS=.*\$/HOOKS=(base systemd sd-vroot sd-localization sd-lvm2 modconf block filesystems fsck $HOOKS)/" /etc/mkinitcpio.conf
sed -i "s/^MODULES=.*\$/MODULES=(squashfs virtio virtio_pci virtio_blk ext4 $MODULES)/" /etc/mkinitcpio.conf

for i in \
  setup-customize-initrd.service \
  setup-profile-home.service\
  $SYSTEMD_SERVICES
do
  systemctl enable $i
done

if [ -n "$SYSTEMD_USER_SERVICES" ]
then
  for i in $SYSTEMD_USER_SERVICES
  do
    systemctl --global --user enable $i
  done
fi

find /etc/systemd
for i in user system
do
  rsync -av --ignore-existing /etc/systemd/$i/ /usr/lib/systemd/$i/
done

sed -e 's/--prompt-locale//' -e 's|--timezone=America/New_York||' -i /usr/lib/systemd/system/systemd-firstboot.service

cat /usr/lib/systemd/system/systemd-firstboot.service

if [ ! -d "/usr/local/opt" ]
then
  mv /opt /usr/local/opt
  ln -sf usr/local/opt /opt
fi

for i in /etc/mkinitcpio.d/*
do
  mkinitcpio -p $(basename $i .preset)
done
rm -r /build
