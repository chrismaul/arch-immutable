#!/bin/bash -ex
if [ "$(ls $PACKAGE_DIR/* | wc -l)" -gt "0" ]
then
  pacman -U $PACKAGE_DIR/* --noconfirm --needed
fi

for i in \
  etc/environment \
  etc/xdg/ \
  etc/cloud/ \
  etc/security/ \
  etc/ca-certificates/ \
  etc/ssl/ \
  etc/pam.d/ \
  etc/profile.d/ \
  etc/bash.bashrc \
  etc/bash.bash_logout \
  $SYNC_FILES
do
  if [ -e "/$i" ]
  then
    rsync -av /$i /usr/share/factory/$i
  fi
done

if [ -d "$PROFILE_FILES" ]
then
  rsync -av $PROFILE_FILES/ /
fi

sed -i "s/^HOOKS=.*\$/HOOKS=(base systemd sd-vroot sd-localization sd-lvm2 modconf block filesystems fsck $HOOKS)/" /etc/mkinitcpio.conf
sed -i "s/^MODULES=.*\$/MODULES=(squashfs virtio virtio_pci virtio_blk ext4 $MODULES)/" /etc/mkinitcpio.conf

for i in \
  setup-customize-initrd.service \
  setup-profile-home.service
do
  mkdir -p /usr/lib/systemd/system/initrd-switch-root.target.wants
  ln -s ../$i /usr/lib/systemd/system/initrd-switch-root.target.wants/$i
done

for i in $SYSTEMD_SERVICES
do
  mkdir -p /usr/lib/systemd/system/multi-user.target.wants
  ln -s ../$i /usr/lib/systemd/system/multi-user.target.wants/$i
done

if [ -n "$SYSTEMD_USER_SERVICES" ]
then
  for i in $SYSTEMD_USER_SERVICES
  do
    mkdir -p /usr/lib/systemd/user/default.target.wants
    ln -s ../$i /usr/lib/systemd/user/default.target.wants/$i
  done
fi

sed -e 's|C! /etc/pam.d|C /etc/pam.d|' -i /usr/lib/tmpfiles.d/etc.conf

if [ ! -d "/usr/local/opt" ]
then
  mv /opt /usr/local/opt
  ln -sf usr/local/opt /opt
fi

for i in /etc/mkinitcpio.d/*
do
  mkinitcpio -p $(basename $i .preset)
done
rm -r /build
